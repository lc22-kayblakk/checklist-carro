<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seleção de Veículo - Carro Certo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <div class="container my-4">
    <h1 class="text-center mb-4">Selecione seu veículo</h1>

    <div class="mb-3">
      <label for="marcaSelect" class="form-label">Marca:</label>
      <select id="marcaSelect" class="form-select">
        <option value="">Selecione uma marca</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="modeloSelect" class="form-label">Modelo:</label>
      <select id="modeloSelect" class="form-select" disabled>
        <option value="">Selecione um modelo</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="anoSelect" class="form-label">Ano:</label>
      <select id="anoSelect" class="form-select" disabled>
        <option value="">Selecione o ano</option>
      </select>
    </div>

    <button id="btnConfirmar" class="btn btn-primary" disabled>Confirmar</button>
  </div>

  <script>
    const marcaSelect = document.getElementById('marcaSelect');
    const modeloSelect = document.getElementById('modeloSelect');
    const anoSelect = document.getElementById('anoSelect');
    const btnConfirmar = document.getElementById('btnConfirmar');

    // Função para popular um select
    function popularSelect(selectElement, itens, textoDefault) {
      selectElement.innerHTML = `<option value="">${textoDefault}</option>`;
      itens.forEach(item => {
        const option = document.createElement('option');
        option.value = item.codigo ?? item.id ?? item.Value ?? item.codigoFipe ?? item.codigoModelo ?? item.codigoAno ?? item.codigoAnoModelo ?? item.codigoModelo ?? item.codigo ?? item.codigoModelo ?? item.codigo ?? item.codigoModelo ?? item.codigo ?? item.codigoModelo ?? item.codigo ?? item.codigoModelo ?? item.codigo ?? item.codigoModelo ?? item.codigo ?? item.codigoModelo ?? item.codigo;
        option.text = item.nome ?? item.Label ?? item.Modelo ?? item.AnoModelo ?? item.Ano ?? item;
        selectElement.appendChild(option);
      });
    }

    // Ajustado para os dados reais da API:
    // marcas: [{nome, codigo}]
    // modelos: {modelos: [{nome, codigo}], anos: [...]}
    // anos: [{nome, codigo}]

    // Buscar marcas na API
    fetch('https://parallelum.com.br/fipe/api/v1/carros/marcas')
      .then(res => res.json())
      .then(data => {
        data.sort((a,b) => a.nome.localeCompare(b.nome)); // ordenar alfabeticamente
        data.forEach(marca => {
          const option = document.createElement('option');
          option.value = marca.codigo;
          option.text = marca.nome;
          marcaSelect.appendChild(option);
        });
      });

    marcaSelect.addEventListener('change', () => {
      const codigoMarca = marcaSelect.value;
      if (!codigoMarca) {
        modeloSelect.innerHTML = '<option value="">Selecione um modelo</option>';
        modeloSelect.disabled = true;
        anoSelect.innerHTML = '<option value="">Selecione o ano</option>';
        anoSelect.disabled = true;
        btnConfirmar.disabled = true;
        return;
      }
      modeloSelect.disabled = false;
      anoSelect.innerHTML = '<option value="">Selecione o ano</option>';
      anoSelect.disabled = true;
      btnConfirmar.disabled = true;
      modeloSelect.innerHTML = '<option value="">Carregando modelos...</option>';

      fetch(`https://parallelum.com.br/fipe/api/v1/carros/marcas/${codigoMarca}/modelos`)
        .then(res => res.json())
        .then(data => {
          modeloSelect.innerHTML = '<option value="">Selecione um modelo</option>';
          data.modelos.sort((a,b) => a.nome.localeCompare(b.nome));
          data.modelos.forEach(modelo => {
            const option = document.createElement('option');
            option.value = modelo.codigo;
            option.text = modelo.nome;
            modeloSelect.appendChild(option);
          });
        });
    });

    modeloSelect.addEventListener('change', () => {
      const codigoMarca = marcaSelect.value;
      const codigoModelo = modeloSelect.value;
      if (!codigoModelo) {
        anoSelect.innerHTML = '<option value="">Selecione o ano</option>';
        anoSelect.disabled = true;
        btnConfirmar.disabled = true;
        return;
      }
      anoSelect.disabled = false;
      btnConfirmar.disabled = true;
      anoSelect.innerHTML = '<option value="">Carregando anos...</option>';

      fetch(`https://parallelum.com.br/fipe/api/v1/carros/marcas/${codigoMarca}/modelos/${codigoModelo}/anos`)
        .then(res => res.json())
        .then(data => {
          anoSelect.innerHTML = '<option value="">Selecione o ano</option>';
          data.sort((a,b) => b.nome.localeCompare(a.nome)); // ordenar decrescente
          data.forEach(ano => {
            const option = document.createElement('option');
            option.value = ano.codigo;
            option.text = ano.nome;
            anoSelect.appendChild(option);
          });
        });
    });

    anoSelect.addEventListener('change', () => {
      btnConfirmar.disabled = !anoSelect.value;
    });

    btnConfirmar.addEventListener('click', () => {
      const codigoMarca = marcaSelect.value;
      const codigoModelo = modeloSelect.value;
      const codigoAno = anoSelect.value;

      const marcaNome = marcaSelect.options[marcaSelect.selectedIndex].text;
      const modeloNome = modeloSelect.options[modeloSelect.selectedIndex].text;
      const anoNome = anoSelect.options[anoSelect.selectedIndex].text;

      if (!codigoMarca || !codigoModelo || !codigoAno) {
        alert('Selecione todos os campos antes de continuar.');
        return;
      }

      // Monta objeto para salvar no localStorage
      const veiculoSelecionado = {
        marcaCodigo: codigoMarca,
        modeloCodigo: codigoModelo,
        anoCodigo: codigoAno,
        marcaNome: marcaNome,
        modeloNome: modeloNome,
        anoNome: anoNome
      };

      localStorage.setItem('veiculoSelecionado', JSON.stringify(veiculoSelecionado));

      // Redireciona para checklist.html
      window.location.href = 'checklist.html';
    });
  </script>
</body>
</html>
